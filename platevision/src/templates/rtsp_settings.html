{% extends "base.html" %}

{% block title %}RTSP Einstellungen - PlateVision{% endblock %}

{% block page_title %}
<i class="fas fa-broadcast-tower me-2"></i>RTSP Stream Einstellungen
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <!-- RTSP URL Configuration -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-link"></i>
                    Stream Verbindung
                </h5>
            </div>
            <div class="card-body">
                <form id="rtspForm">
                    <div class="mb-4">
                        <label class="form-label">RTSP URL</label>
                        <div class="input-group">
                            <span class="input-group-text bg-transparent">
                                <i class="fas fa-video text-primary"></i>
                            </span>
                            <input type="text" class="form-control" id="rtspUrl" 
                                   placeholder="rtsp://username:password@ip:port/stream"
                                   value="{{ config.url if config else '' }}">
                            <button type="button" class="btn btn-outline-secondary" onclick="testConnection()">
                                <i class="fas fa-plug me-1"></i>Testen
                            </button>
                        </div>
                        <small class="text-secondary">
                            Beispiel: rtsp://admin:password@192.168.1.100:554/stream1
                        </small>
                    </div>
                    
                    <!-- Common RTSP URL Templates -->
                    <div class="mb-4">
                        <label class="form-label">URL Vorlagen</label>
                        <div class="d-flex flex-wrap gap-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="setTemplate('hikvision')">Hikvision</button>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="setTemplate('dahua')">Dahua</button>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="setTemplate('reolink')">Reolink</button>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="setTemplate('axis')">Axis</button>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="setTemplate('generic')">Generisch</button>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <!-- Connection Settings -->
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Reconnect Verzögerung (Sekunden)</label>
                            <input type="number" class="form-control" id="reconnectDelay" 
                                   min="1" max="60" value="{{ config.reconnect_delay if config else 5 }}">
                            <small class="text-secondary">Zeit bis zum erneuten Verbindungsversuch</small>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Buffer Größe (Frames)</label>
                            <input type="number" class="form-control" id="bufferSize" 
                                   min="1" max="50" value="{{ config.buffer_size if config else 10 }}">
                            <small class="text-secondary">Größerer Buffer = mehr Latenz, stabiler</small>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Einstellungen speichern
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="resetToDefaults()">
                            <i class="fas fa-undo me-2"></i>Zurücksetzen
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Area Selection -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-crop-alt"></i>
                    Analyse-Bereich festlegen
                </h5>
                <span id="areaStatusBadge" class="badge bg-secondary">Deaktiviert</span>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="enableAreaSelection" style="width: 3em; height: 1.5em;">
                        <label class="form-check-label ms-2" for="enableAreaSelection">
                            <strong>Analyse auf bestimmten Bereich beschränken</strong>
                        </label>
                    </div>
                    <small class="text-secondary d-block mt-1">
                        Nur Fahrzeuge und Kennzeichen innerhalb des markierten Bereichs werden erkannt.
                    </small>
                </div>
                
                <div id="areaSelectionControls" style="display: none;">
                    <div class="alert alert-info small mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Anleitung:</strong> Klicken und ziehen Sie im Vorschaubild, um den Analysebereich zu definieren.
                        Die Koordinaten werden automatisch auf die tatsächliche Stream-Auflösung skaliert.
                    </div>
                    
                    <!-- Preview Container -->
                    <div class="mb-3">
                        <label class="form-label">Stream Vorschau</label>
                        <div id="previewContainer" class="position-relative border rounded overflow-hidden" 
                             style="background: #1a1a2e; aspect-ratio: 16/9; max-height: 500px;">
                            
                            <!-- Stream Image -->
                            <img id="previewImage" src="" alt="Stream Vorschau" 
                                 style="width: 100%; height: 100%; object-fit: contain; display: none;"
                                 crossorigin="anonymous">
                            
                            <!-- Canvas Overlay für Zeichnung -->
                            <canvas id="selectionCanvas" 
                                    style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: crosshair;">
                            </canvas>
                            
                            <!-- Placeholder wenn kein Stream -->
                            <div id="noStreamPlaceholder" class="position-absolute top-0 start-0 w-100 h-100 d-flex flex-column justify-content-center align-items-center text-white">
                                <i class="fas fa-video-slash fa-4x mb-3 text-secondary"></i>
                                <p class="mb-3 text-secondary">Stream nicht aktiv oder lädt...</p>
                                <button class="btn btn-primary" onclick="loadPreviewImage()">
                                    <i class="fas fa-sync me-2"></i>Vorschau laden
                                </button>
                            </div>
                        </div>
                        
                        <!-- Stream Info -->
                        <div class="d-flex justify-content-between mt-2 small text-secondary">
                            <span id="streamResolutionInfo">Auflösung: Unbekannt</span>
                            <span id="displayResolutionInfo">Anzeige: Unbekannt</span>
                        </div>
                    </div>
                    
                    <!-- Koordinaten-Eingabe -->
                    <div class="card bg-dark mb-3">
                        <div class="card-header py-2">
                            <strong>Bereichs-Koordinaten (in Stream-Pixeln)</strong>
                        </div>
                        <div class="card-body py-3">
                            <div class="row g-3">
                                <div class="col-6 col-md-3">
                                    <label class="form-label small">X (Links)</label>
                                    <div class="input-group input-group-sm">
                                        <input type="number" class="form-control" id="areaX" min="0" value="0">
                                        <span class="input-group-text">px</span>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <label class="form-label small">Y (Oben)</label>
                                    <div class="input-group input-group-sm">
                                        <input type="number" class="form-control" id="areaY" min="0" value="0">
                                        <span class="input-group-text">px</span>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <label class="form-label small">Breite</label>
                                    <div class="input-group input-group-sm">
                                        <input type="number" class="form-control" id="areaWidth" min="50" value="1280">
                                        <span class="input-group-text">px</span>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <label class="form-label small">Höhe</label>
                                    <div class="input-group input-group-sm">
                                        <input type="number" class="form-control" id="areaHeight" min="50" value="720">
                                        <span class="input-group-text">px</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Aktions-Buttons -->
                    <div class="d-flex flex-wrap gap-2 mb-3">
                        <button type="button" class="btn btn-outline-primary" onclick="resetAreaToFull()">
                            <i class="fas fa-expand me-2"></i>Ganzes Bild
                        </button>
                        <button type="button" class="btn btn-outline-warning" onclick="centerArea()">
                            <i class="fas fa-crosshairs me-2"></i>Mitte (50%)
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="setLowerHalf()">
                            <i class="fas fa-arrow-down me-2"></i>Untere Hälfte
                        </button>
                        <button type="button" class="btn btn-success" onclick="saveAreaSettings()">
                            <i class="fas fa-save me-2"></i>Bereich speichern
                        </button>
                    </div>
                    
                    <!-- Bereichs-Info -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card bg-secondary bg-opacity-25">
                                <div class="card-body py-2">
                                    <div class="d-flex justify-content-between">
                                        <span class="text-secondary">Position:</span>
                                        <strong id="infoPosition">0, 0</strong>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span class="text-secondary">Größe:</span>
                                        <strong id="infoSize">0 × 0</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-secondary bg-opacity-25">
                                <div class="card-body py-2">
                                    <div class="d-flex justify-content-between">
                                        <span class="text-secondary">Fläche:</span>
                                        <strong id="infoPixels">0 Pixel</strong>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span class="text-secondary">Anteil:</span>
                                        <strong id="infoPercent">0%</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Test Results -->
        <div class="card" id="testResultCard" style="display: none;">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-vial"></i>
                    Verbindungstest
                </h5>
            </div>
            <div class="card-body">
                <div id="testResult"></div>
            </div>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Stream Status -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle"></i>
                    Stream Status
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center gap-3 mb-3">
                    <div id="streamStatusIcon" class="rounded-circle p-3 bg-secondary bg-opacity-25">
                        <i class="fas fa-stop fa-lg text-secondary"></i>
                    </div>
                    <div>
                        <div id="streamStatusText" class="fw-bold">STOPPED</div>
                        <small class="text-secondary">Aktueller Status</small>
                    </div>
                </div>
                
                <div id="streamError" class="alert alert-danger mb-3" style="display: none;">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="streamErrorText"></span>
                </div>
                
                <div id="streamStats" class="mb-3" style="display: none;">
                    <div class="row g-2 text-center">
                        <div class="col-4">
                            <div class="p-2 bg-dark rounded">
                                <div id="statFps" class="h5 mb-0 text-primary">0</div>
                                <small class="text-secondary">FPS</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 bg-dark rounded">
                                <div id="statFrames" class="h5 mb-0 text-success">0</div>
                                <small class="text-secondary">Frames</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 bg-dark rounded">
                                <div id="statDetections" class="h5 mb-0 text-warning">0</div>
                                <small class="text-secondary">Erkannt</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="d-grid gap-2">
                    <button id="btnStartStream" class="btn btn-success" onclick="startStream()">
                        <i class="fas fa-play me-2"></i>Stream starten
                    </button>
                    <button id="btnStopStream" class="btn btn-danger" onclick="stopStream()" style="display: none;">
                        <i class="fas fa-stop me-2"></i>Stream stoppen
                    </button>
                    <a href="{{ url_for('live_view') }}" class="btn btn-outline-primary">
                        <i class="fas fa-video me-2"></i>Live Ansicht öffnen
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Tipps -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-lightbulb"></i>
                    Tipps für Bereichsauswahl
                </h5>
            </div>
            <div class="card-body">
                <ul class="small mb-0 ps-3">
                    <li class="mb-2">Wählen Sie nur den Bereich, in dem Fahrzeuge erscheinen</li>
                    <li class="mb-2">Kleinere Bereiche = schnellere Verarbeitung</li>
                    <li class="mb-2">Vermeiden Sie Bereiche mit viel Bewegung (Bäume, Wasser)</li>
                    <li class="mb-2">Der Bereich sollte Kennzeichen vollständig erfassen</li>
                    <li>Bei Einfahrten: Untere Bildhälfte oft optimal</li>
                </ul>
            </div>
        </div>
        
        <!-- Help Accordion -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-question-circle"></i>
                    Hilfe
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="accordion accordion-flush" id="helpAccordion">
                    <div class="accordion-item bg-transparent border-0">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed bg-transparent text-light py-3" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#help1">
                                Wie finde ich meine RTSP URL?
                            </button>
                        </h2>
                        <div id="help1" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                            <div class="accordion-body text-secondary small pt-0">
                                Die RTSP URL finden Sie in der Dokumentation Ihrer Kamera oder im Web-Interface 
                                unter "Netzwerk" oder "Stream" Einstellungen. Nutzen Sie die Vorlagen als Ausgangspunkt.
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item bg-transparent border-0">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed bg-transparent text-light py-3" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#help2">
                                Stream verbindet nicht?
                            </button>
                        </h2>
                        <div id="help2" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                            <div class="accordion-body text-secondary small pt-0">
                                <ul class="mb-0 ps-3">
                                    <li>Überprüfen Sie IP-Adresse und Port</li>
                                    <li>Stellen Sie sicher, dass RTSP aktiviert ist</li>
                                    <li>Prüfen Sie Benutzername und Passwort</li>
                                    <li>Firewall-Einstellungen überprüfen</li>
                                    <li>Testen Sie die URL mit VLC Media Player</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item bg-transparent border-0">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed bg-transparent text-light py-3" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#help3">
                                Bereich wird nicht korrekt angewendet?
                            </button>
                        </h2>
                        <div id="help3" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                            <div class="accordion-body text-secondary small pt-0">
                                Die Koordinaten beziehen sich auf die tatsächliche Stream-Auflösung.
                                Stellen Sie sicher, dass der Stream aktiv ist, bevor Sie den Bereich festlegen.
                                Nach dem Speichern wird der Bereich bei der nächsten Frame-Verarbeitung angewendet.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ============================================
// GLOBALE VARIABLEN
// ============================================

let streamWidth = 1280;
let streamHeight = 720;
let displayWidth = 0;
let displayHeight = 0;
let isDrawing = false;
let startX = 0;
let startY = 0;
let currentArea = { x: 0, y: 0, width: 1280, height: 720 };
let isAreaEnabled = false;
let previewLoaded = false;
let statusInterval = null;

// RTSP URL Templates
const templates = {
    hikvision: 'rtsp://{user}:{pass}@{ip}:554/Streaming/Channels/101',
    dahua: 'rtsp://{user}:{pass}@{ip}:554/cam/realmonitor?channel=1&subtype=0',
    reolink: 'rtsp://{user}:{pass}@{ip}:554/h264Preview_01_main',
    axis: 'rtsp://{user}:{pass}@{ip}/axis-media/media.amp',
    generic: 'rtsp://{user}:{pass}@{ip}:554/stream1'
};

// ============================================
// INITIALISIERUNG
// ============================================

document.addEventListener('DOMContentLoaded', function() {
    // Konfiguration laden
    loadConfiguration();
    
    // Event Listeners
    setupEventListeners();
    
    // Status-Updates starten
    startStatusUpdates();
    
    // Canvas initialisieren
    initCanvas();
});

function loadConfiguration() {
    fetch('/api/config')
        .then(response => response.json())
        .then(config => {
            const rtspConfig = config.rtsp || {};
            
            // RTSP URL
            if (rtspConfig.url) {
                document.getElementById('rtspUrl').value = rtspConfig.url;
            }
            
            // Reconnect Delay
            if (rtspConfig.reconnect_delay) {
                document.getElementById('reconnectDelay').value = rtspConfig.reconnect_delay;
            }
            
            // Buffer Size
            if (rtspConfig.buffer_size) {
                document.getElementById('bufferSize').value = rtspConfig.buffer_size;
            }
            
            // Analysis Area
            const areaConfig = rtspConfig.analysis_area || {};
            isAreaEnabled = areaConfig.enabled || false;
            
            document.getElementById('enableAreaSelection').checked = isAreaEnabled;
            
            if (areaConfig.area) {
                currentArea = {
                    x: parseInt(areaConfig.area.x) || 0,
                    y: parseInt(areaConfig.area.y) || 0,
                    width: parseInt(areaConfig.area.width) || 1280,
                    height: parseInt(areaConfig.area.height) || 720
                };
            }
            
            // Resolution from config (Fallback)
            if (rtspConfig.resolution) {
                streamWidth = rtspConfig.resolution.width || 1280;
                streamHeight = rtspConfig.resolution.height || 720;
            }
            
            updateAreaUI();
            updateAreaInputs();
            updateAreaInfo();
        })
        .catch(error => {
            console.error('Fehler beim Laden der Konfiguration:', error);
        });
    
    // Stream-Auflösung vom Server holen
    fetch('/api/stream/status')
        .then(response => response.json())
        .then(status => {
            if (status.resolution) {
                streamWidth = status.resolution.width || 1280;
                streamHeight = status.resolution.height || 720;
                updateResolutionInfo();
            }
            updateStreamStatusUI(status);
        })
        .catch(error => {
            console.error('Fehler beim Laden des Stream-Status:', error);
        });
}

function setupEventListeners() {
    // Formular Submit
    document.getElementById('rtspForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveRtspSettings();
    });
    
    // Area Checkbox
    document.getElementById('enableAreaSelection').addEventListener('change', function() {
        isAreaEnabled = this.checked;
        updateAreaUI();
        
        if (isAreaEnabled && !previewLoaded) {
            loadPreviewImage();
        }
    });
    
    // Area Input Felder
    ['areaX', 'areaY', 'areaWidth', 'areaHeight'].forEach(id => {
        document.getElementById(id).addEventListener('input', function() {
            updateAreaFromInputs();
        });
        
        document.getElementById(id).addEventListener('change', function() {
            updateAreaFromInputs();
            drawSelection();
        });
    });
    
    // Canvas Events
    const canvas = document.getElementById('selectionCanvas');
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', handleMouseMove);
    canvas.addEventListener('mouseup', endDrawing);
    canvas.addEventListener('mouseleave', endDrawing);
    
    // Touch Events für Mobile
    canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
    canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
    canvas.addEventListener('touchend', endDrawing);
    
    // Bild geladen
    document.getElementById('previewImage').addEventListener('load', function() {
        previewLoaded = true;
        document.getElementById('noStreamPlaceholder').style.display = 'none';
        this.style.display = 'block';
        
        // Canvas-Größe aktualisieren
        updateCanvasSize();
        drawSelection();
    });
    
    document.getElementById('previewImage').addEventListener('error', function() {
        previewLoaded = false;
        this.style.display = 'none';
        document.getElementById('noStreamPlaceholder').style.display = 'flex';
    });
    
    // Window Resize
    window.addEventListener('resize', function() {
        if (previewLoaded) {
            updateCanvasSize();
            drawSelection();
        }
    });
}

function initCanvas() {
    const canvas = document.getElementById('selectionCanvas');
    const container = document.getElementById('previewContainer');
    
    // Initiale Größe
    canvas.width = container.clientWidth;
    canvas.height = container.clientHeight;
}

// ============================================
// STREAM STATUS
// ============================================

function startStatusUpdates() {
    updateStreamStatus();
    statusInterval = setInterval(updateStreamStatus, 2000);
}

function updateStreamStatus() {
    fetch('/api/stream/status')
        .then(response => response.json())
        .then(status => {
            updateStreamStatusUI(status);
            
            // Auflösung aktualisieren wenn verbunden
            if (status.connected && status.resolution) {
                streamWidth = status.resolution.width || streamWidth;
                streamHeight = status.resolution.height || streamHeight;
                updateResolutionInfo();
            }
        })
        .catch(error => {
            console.error('Status-Update Fehler:', error);
        });
}

function updateStreamStatusUI(status) {
    const isRunning = status.status === 'running';
    const isConnected = status.connected;
    
    // Status Icon
    const iconDiv = document.getElementById('streamStatusIcon');
    const statusText = document.getElementById('streamStatusText');
    
    if (isRunning && isConnected) {
        iconDiv.className = 'rounded-circle p-3 bg-success bg-opacity-25';
        iconDiv.innerHTML = '<i class="fas fa-play fa-lg text-success"></i>';
        statusText.textContent = 'VERBUNDEN';
        statusText.className = 'fw-bold text-success';
    } else if (isRunning) {
        iconDiv.className = 'rounded-circle p-3 bg-warning bg-opacity-25';
        iconDiv.innerHTML = '<i class="fas fa-spinner fa-spin fa-lg text-warning"></i>';
        statusText.textContent = 'VERBINDET...';
        statusText.className = 'fw-bold text-warning';
    } else {
        iconDiv.className = 'rounded-circle p-3 bg-secondary bg-opacity-25';
        iconDiv.innerHTML = '<i class="fas fa-stop fa-lg text-secondary"></i>';
        statusText.textContent = 'GESTOPPT';
        statusText.className = 'fw-bold text-secondary';
    }
    
    // Buttons
    document.getElementById('btnStartStream').style.display = isRunning ? 'none' : 'block';
    document.getElementById('btnStopStream').style.display = isRunning ? 'block' : 'none';
    
    // Error
    const errorDiv = document.getElementById('streamError');
    if (status.error && !isConnected) {
        errorDiv.style.display = 'block';
        document.getElementById('streamErrorText').textContent = status.error;
    } else {
        errorDiv.style.display = 'none';
    }
    
    // Stats
    const statsDiv = document.getElementById('streamStats');
    if (isRunning) {
        statsDiv.style.display = 'block';
        document.getElementById('statFps').textContent = status.fps || 0;
        document.getElementById('statFrames').textContent = formatNumber(status.frame_count || 0);
        document.getElementById('statDetections').textContent = status.detection_count || 0;
    } else {
        statsDiv.style.display = 'none';
    }
}

function formatNumber(num) {
    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
    if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
    return num.toString();
}

// ============================================
// PREVIEW & CANVAS
// ============================================

function loadPreviewImage() {
    const img = document.getElementById('previewImage');
    const placeholder = document.getElementById('noStreamPlaceholder');
    
    placeholder.innerHTML = `
        <div class="spinner-border text-primary mb-3" role="status"></div>
        <p class="text-secondary">Lade Vorschau...</p>
    `;
    
    // Snapshot vom Stream laden
    img.src = '/api/stream/snapshot?' + Date.now();
}

function updateCanvasSize() {
    const canvas = document.getElementById('selectionCanvas');
    const img = document.getElementById('previewImage');
    const container = document.getElementById('previewContainer');
    
    // Container-Größe
    const containerRect = container.getBoundingClientRect();
    
    // Canvas auf Container-Größe setzen
    canvas.style.width = '100%';
    canvas.style.height = '100%';
    
    // Interne Canvas-Auflösung = Stream-Auflösung für präzise Koordinaten
    canvas.width = streamWidth;
    canvas.height = streamHeight;
    
    // Display-Größe speichern
    displayWidth = containerRect.width;
    displayHeight = containerRect.height;
    
    updateResolutionInfo();
}

function updateResolutionInfo() {
    document.getElementById('streamResolutionInfo').textContent = `Stream: ${streamWidth} × ${streamHeight}`;
    document.getElementById('displayResolutionInfo').textContent = `Anzeige: ${Math.round(displayWidth)} × ${Math.round(displayHeight)}`;
    
    // Max-Werte für Inputs aktualisieren
    document.getElementById('areaX').max = streamWidth;
    document.getElementById('areaY').max = streamHeight;
    document.getElementById('areaWidth').max = streamWidth;
    document.getElementById('areaHeight').max = streamHeight;
}

// ============================================
// ZEICHENFUNKTIONEN
// ============================================

function getCanvasCoordinates(e) {
    const canvas = document.getElementById('selectionCanvas');
    const rect = canvas.getBoundingClientRect();
    
    // Skalierung von Display zu Stream-Koordinaten
    const scaleX = streamWidth / rect.width;
    const scaleY = streamHeight / rect.height;
    
    let clientX, clientY;
    
    if (e.touches) {
        clientX = e.touches[0].clientX;
        clientY = e.touches[0].clientY;
    } else {
        clientX = e.clientX;
        clientY = e.clientY;
    }
    
    return {
        x: Math.round((clientX - rect.left) * scaleX),
        y: Math.round((clientY - rect.top) * scaleY)
    };
}

function startDrawing(e) {
    if (!isAreaEnabled) return;
    
    e.preventDefault();
    isDrawing = true;
    
    const coords = getCanvasCoordinates(e);
    startX = coords.x;
    startY = coords.y;
}

function handleMouseMove(e) {
    if (!isDrawing || !isAreaEnabled) return;
    
    e.preventDefault();
    
    const coords = getCanvasCoordinates(e);
    updateSelectionFromDrag(coords.x, coords.y);
}

function handleTouchStart(e) {
    if (!isAreaEnabled) return;
    e.preventDefault();
    startDrawing(e);
}

function handleTouchMove(e) {
    if (!isDrawing || !isAreaEnabled) return;
    e.preventDefault();
    
    const coords = getCanvasCoordinates(e);
    updateSelectionFromDrag(coords.x, coords.y);
}

function updateSelectionFromDrag(currentX, currentY) {
    // Berechne Rechteck
    let x = Math.min(startX, currentX);
    let y = Math.min(startY, currentY);
    let width = Math.abs(currentX - startX);
    let height = Math.abs(currentY - startY);
    
    // Minimum-Größe
    width = Math.max(width, 50);
    height = Math.max(height, 50);
    
    // Grenzen einhalten
    x = Math.max(0, Math.min(x, streamWidth - width));
    y = Math.max(0, Math.min(y, streamHeight - height));
    width = Math.min(width, streamWidth - x);
    height = Math.min(height, streamHeight - y);
    
    currentArea = { x, y, width, height };
    
    updateAreaInputs();
    updateAreaInfo();
    drawSelection();
}

function endDrawing() {
    if (isDrawing) {
        isDrawing = false;
        // Auto-Save optional
        // saveAreaSettings();
    }
}

function drawSelection() {
    const canvas = document.getElementById('selectionCanvas');
    const ctx = canvas.getContext('2d');
    
    // Canvas löschen
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    if (!isAreaEnabled) return;
    
    const { x, y, width, height } = currentArea;
    
    // Semi-transparentes Overlay außerhalb des Bereichs
    ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';
    
    // Oben
    ctx.fillRect(0, 0, canvas.width, y);
    // Unten
    ctx.fillRect(0, y + height, canvas.width, canvas.height - y - height);
    // Links
    ctx.fillRect(0, y, x, height);
    // Rechts
    ctx.fillRect(x + width, y, canvas.width - x - width, height);
    
    // Rahmen um ausgewählten Bereich
    ctx.strokeStyle = '#00ff00';
    ctx.lineWidth = 3;
    ctx.strokeRect(x, y, width, height);
    
    // Eckpunkte
    const cornerSize = 15;
    ctx.fillStyle = '#00ff00';
    
    // Oben-Links
    ctx.fillRect(x - 2, y - 2, cornerSize, 4);
    ctx.fillRect(x - 2, y - 2, 4, cornerSize);
    
    // Oben-Rechts
    ctx.fillRect(x + width - cornerSize + 2, y - 2, cornerSize, 4);
    ctx.fillRect(x + width - 2, y - 2, 4, cornerSize);
    
    // Unten-Links
    ctx.fillRect(x - 2, y + height - 2, cornerSize, 4);
    ctx.fillRect(x - 2, y + height - cornerSize + 2, 4, cornerSize);
    
    // Unten-Rechts
    ctx.fillRect(x + width - cornerSize + 2, y + height - 2, cornerSize, 4);
    ctx.fillRect(x + width - 2, y + height - cornerSize + 2, 4, cornerSize);
    
    // Info-Text im Bereich
    ctx.fillStyle = 'rgba(0, 255, 0, 0.9)';
    ctx.font = 'bold 16px Arial';
    const text = `${width} × ${height} px`;
    const textWidth = ctx.measureText(text).width;
    
    // Hintergrund für Text
    ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
    ctx.fillRect(x + 5, y + 5, textWidth + 10, 24);
    
    ctx.fillStyle = '#00ff00';
    ctx.fillText(text, x + 10, y + 22);
}

// ============================================
// AREA MANAGEMENT
// ============================================

function updateAreaUI() {
    const controls = document.getElementById('areaSelectionControls');
    const badge = document.getElementById('areaStatusBadge');
    
    if (isAreaEnabled) {
        controls.style.display = 'block';
        badge.textContent = 'Aktiv';
        badge.className = 'badge bg-success';
    } else {
        controls.style.display = 'none';
        badge.textContent = 'Deaktiviert';
        badge.className = 'badge bg-secondary';
    }
}

function updateAreaInputs() {
    document.getElementById('areaX').value = Math.round(currentArea.x);
    document.getElementById('areaY').value = Math.round(currentArea.y);
    document.getElementById('areaWidth').value = Math.round(currentArea.width);
    document.getElementById('areaHeight').value = Math.round(currentArea.height);
}

function updateAreaFromInputs() {
    currentArea.x = parseInt(document.getElementById('areaX').value) || 0;
    currentArea.y = parseInt(document.getElementById('areaY').value) || 0;
    currentArea.width = parseInt(document.getElementById('areaWidth').value) || 100;
    currentArea.height = parseInt(document.getElementById('areaHeight').value) || 100;
    
    // Grenzen einhalten
    currentArea.x = Math.max(0, Math.min(currentArea.x, streamWidth - 50));
    currentArea.y = Math.max(0, Math.min(currentArea.y, streamHeight - 50));
    currentArea.width = Math.max(50, Math.min(currentArea.width, streamWidth - currentArea.x));
    currentArea.height = Math.max(50, Math.min(currentArea.height, streamHeight - currentArea.y));
    
    updateAreaInfo();
    drawSelection();
}

function updateAreaInfo() {
    const { x, y, width, height } = currentArea;
    const pixels = width * height;
    const totalPixels = streamWidth * streamHeight;
    const percent = totalPixels > 0 ? Math.round((pixels / totalPixels) * 100) : 0;
    
    document.getElementById('infoPosition').textContent = `${x}, ${y}`;
    document.getElementById('infoSize').textContent = `${width} × ${height}`;
    document.getElementById('infoPixels').textContent = pixels.toLocaleString() + ' px';
    document.getElementById('infoPercent').textContent = percent + '%';
}

function resetAreaToFull() {
    currentArea = { x: 0, y: 0, width: streamWidth, height: streamHeight };
    updateAreaInputs();
    updateAreaInfo();
    drawSelection();
}

function centerArea() {
    const width = Math.round(streamWidth * 0.5);
    const height = Math.round(streamHeight * 0.5);
    currentArea = {
        x: Math.round((streamWidth - width) / 2),
        y: Math.round((streamHeight - height) / 2),
        width: width,
        height: height
    };
    updateAreaInputs();
    updateAreaInfo();
    drawSelection();
}

function setLowerHalf() {
    currentArea = {
        x: 0,
        y: Math.round(streamHeight / 2),
        width: streamWidth,
        height: Math.round(streamHeight / 2)
    };
    updateAreaInputs();
    updateAreaInfo();
    drawSelection();
}

// ============================================
// SPEICHERN & API
// ============================================

function saveRtspSettings() {
    const data = {
        url: document.getElementById('rtspUrl').value,
        reconnect_delay: parseInt(document.getElementById('reconnectDelay').value) || 5,
        buffer_size: parseInt(document.getElementById('bufferSize').value) || 10
    };
    
    fetch('/api/config/rtsp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('Erfolg', 'RTSP Einstellungen gespeichert', 'success');
        } else {
            showToast('Fehler', result.error || 'Speichern fehlgeschlagen', 'danger');
        }
    })
    .catch(error => {
        showToast('Fehler', 'Verbindungsfehler: ' + error.message, 'danger');
    });
}

function saveAreaSettings() {
    const data = {
        analysis_area: {
            enabled: isAreaEnabled,
            area: {
                x: Math.round(currentArea.x),
                y: Math.round(currentArea.y),
                width: Math.round(currentArea.width),
                height: Math.round(currentArea.height)
            }
        }
    };
    
    fetch('/api/config/rtsp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('Erfolg', 'Analysebereich gespeichert', 'success');
        } else {
            showToast('Fehler', result.error || 'Speichern fehlgeschlagen', 'danger');
        }
    })
    .catch(error => {
        showToast('Fehler', 'Verbindungsfehler: ' + error.message, 'danger');
    });
}

// ============================================
// STREAM KONTROLLE
// ============================================

function startStream() {
    fetch('/api/stream/start', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Stream', 'Stream wird gestartet...', 'success');
                setTimeout(() => {
                    updateStreamStatus();
                    if (isAreaEnabled) {
                        loadPreviewImage();
                    }
                }, 1500);
            } else {
                showToast('Fehler', data.status?.error || 'Start fehlgeschlagen', 'danger');
            }
        })
        .catch(error => {
            showToast('Fehler', 'Verbindungsfehler: ' + error.message, 'danger');
        });
}

function stopStream() {
    fetch('/api/stream/stop', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            showToast('Stream', 'Stream gestoppt', 'warning');
            updateStreamStatus();
        })
        .catch(error => {
            showToast('Fehler', 'Verbindungsfehler: ' + error.message, 'danger');
        });
}

function testConnection() {
    const url = document.getElementById('rtspUrl').value;
    if (!url) {
        showToast('Fehler', 'Bitte RTSP URL eingeben', 'warning');
        return;
    }
    
    const resultCard = document.getElementById('testResultCard');
    const resultDiv = document.getElementById('testResult');
    
    resultCard.style.display = 'block';
    resultDiv.innerHTML = `
        <div class="d-flex align-items-center gap-3">
            <div class="spinner-border text-primary" role="status"></div>
            <span>Teste Verbindung...</span>
        </div>
    `;
    
    // Speichern und Stream starten zum Testen
    saveRtspSettings();
    
    setTimeout(() => {
        fetch('/api/stream/status')
            .then(response => response.json())
            .then(status => {
                if (status.connected) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success mb-0">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Verbindung erfolgreich!</strong><br>
                            <small>Stream-Auflösung: ${status.resolution?.width || '?'} × ${status.resolution?.height || '?'}</small>
                        </div>
                    `;
                } else if (status.status === 'running') {
                    resultDiv.innerHTML = `
                        <div class="alert alert-warning mb-0">
                            <i class="fas fa-hourglass-half me-2"></i>
                            <strong>Verbindung wird hergestellt...</strong><br>
                            <small>Bitte warten Sie einen Moment.</small>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Stream nicht aktiv</strong><br>
                            <small>Starten Sie den Stream, um die Verbindung zu testen.</small>
                        </div>
                    `;
                }
            });
    }, 2000);
}

// ============================================
// HILFSFUNKTIONEN
// ============================================

function setTemplate(type) {
    const template = templates[type];
    if (template) {
        document.getElementById('rtspUrl').value = template;
        showToast('Vorlage', `${type.charAt(0).toUpperCase() + type.slice(1)} Vorlage eingefügt`, 'info');
    }
}

function resetToDefaults() {
    if (confirm('Alle RTSP Einstellungen zurücksetzen?')) {
        document.getElementById('rtspUrl').value = 'rtsp://admin:password@192.168.1.100:554/stream1';
        document.getElementById('reconnectDelay').value = 5;
        document.getElementById('bufferSize').value = 10;
        showToast('Zurückgesetzt', 'Standardwerte wiederhergestellt', 'info');
    }
}

function showToast(title, message, type = 'info') {
    // Prüfen ob showToast global verfügbar ist (aus base.html)
    if (typeof window.showToast === 'function' && window.showToast !== showToast) {
        window.showToast(title, message, type);
        return;
    }
    
    // Fallback: Alert
    console.log(`[${type.toUpperCase()}] ${title}: ${message}`);
    
    // Einfache Toast-Implementierung
    const toastContainer = document.getElementById('toastContainer') || createToastContainer();
    
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <strong>${title}:</strong> ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => toast.remove());
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toastContainer';
    container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
    container.style.zIndex = '9999';
    document.body.appendChild(container);
    return container;
}

// Cleanup bei Seitenwechsel
window.addEventListener('beforeunload', function() {
    if (statusInterval) {
        clearInterval(statusInterval);
    }
});
</script>
{% endblock %}
